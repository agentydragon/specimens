---
apiVersion: v1
kind: Namespace
metadata:
  name: firecrawl
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: firecrawl
  namespace: firecrawl
spec:
  interval: 15m
  timeout: 10m
  chart:
    spec:
      chart: ./charts/firecrawl
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
  values:
    # Replicas
    replicaCount: 1

    # NUQ Worker configuration (reduced for small cluster)
    nuqWorker:
      replicaCount: 2
      resources:
        requests:
          memory: "1Gi"
          cpu: "250m"
        limits:
          memory: "2Gi"
          cpu: "500m"

    # NUQ PostgreSQL configuration
    nuqPostgres:
      replicaCount: 1
      image:
        repository: ghcr.io/firecrawl/nuq-postgres
        tag: latest
        pullPolicy: Always
      auth:
        username: postgres
        database: postgres
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "250m"
      persistence:
        enabled: false # Using ephemeral storage for now

    # Main Firecrawl image
    image:
      repository: ghcr.io/firecrawl/firecrawl
      tag: "latest"
      pullPolicy: Always
      dockerSecretEnabled: false # Public image, no secret needed

    # Playwright service
    playwright:
      repository: ghcr.io/firecrawl/playwright-service
      tag: "latest"
      pullPolicy: Always
      healthCheck:
        enabled: false # Current image doesn't support /health/liveness and /health/readiness endpoints

    # Redis configuration
    redis:
      image: redis:alpine
      replicaCount: 1

    # Service configuration
    service:
      api:
        type: ClusterIP
        port: 3002
      playwright:
        type: ClusterIP
        port: 3000
      redis:
        type: ClusterIP
        port: 6379

    # Application configuration
    config:
      NUM_WORKERS_PER_QUEUE: "4" # Reduced for small cluster
      PORT: "3002"
      HOST: "0.0.0.0"
      REDIS_URL: "redis://firecrawl-firecrawl-redis:6379"
      REDIS_RATE_LIMIT_URL: "redis://firecrawl-firecrawl-redis:6379"
      PLAYWRIGHT_MICROSERVICE_URL: "http://firecrawl-firecrawl-playwright:3000"
      USE_DB_AUTHENTICATION: "false"
      HDX_NODE_BETA_MODE: "1"
      NUQ_DATABASE_URL: "postgresql://postgres:password@firecrawl-firecrawl-nuq-postgres:5432/postgres"

    # Playwright configuration
    playwrightConfig:
      PORT: "3000"

    # Secret configuration (all empty for basic deployment)
    secret:
      OPENAI_API_KEY: ""
      SLACK_WEBHOOK_URL: ""
      LLAMAPARSE_API_KEY: ""
      BULL_AUTH_KEY: ""
      TEST_API_KEY: ""
      POSTHOG_API_KEY: ""
      POSTHOG_HOST: ""
      SCRAPING_BEE_API_KEY: ""
      STRIPE_PRICE_ID_STANDARD: ""
      STRIPE_PRICE_ID_SCALE: ""
      FIRE_ENGINE_BETA_URL: ""
      REDIS_PASSWORD: ""

    # Ingress configuration
    ingress:
      enabled: true
      className: "nginx"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/proxy-body-size: "100m" # Allow large file uploads for scraping
      hosts:
        - host: firecrawl.test-cluster.agentydragon.com
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: firecrawl-tls
          hosts:
            - firecrawl.test-cluster.agentydragon.com
