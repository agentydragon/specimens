---
apiVersion: v1
kind: Namespace
metadata:
  name: gitea
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: gitea-charts
  namespace: gitea
spec:
  interval: 24h
  url: https://dl.gitea.com/charts/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitea
  namespace: gitea
spec:
  interval: 15m
  timeout: 15m # Extended timeout for Gitea deployment (PostgreSQL + PVC binding + init containers)
  chart:
    spec:
      chart: gitea
      version: "12.4.0"
      sourceRef:
        kind: HelmRepository
        name: gitea-charts
        namespace: gitea
  values:
    # Global configuration
    global:
      imageRegistry: ""

    # CRITICAL: Use Recreate strategy for RWO volumes
    # RollingUpdate + RWO volumes = deadlock when init containers fail
    # See docs/RWO_VOLUME_DEPLOYMENT_STRATEGY.md for details
    strategy:
      type: Recreate

    # Gitea configuration
    gitea:
      admin:
        # Username and password from ESO-generated secret
        existingSecret: "gitea-admin-password"
        email: "admin@test-cluster.agentydragon.com"

      # OAuth2 authentication sources
      oauth:
        - name: "authentik"
          provider: "openidConnect"
          existingSecret: "gitea-oauth-client-secret"
          autoDiscoverUrl: "https://auth.test-cluster.agentydragon.com/application/o/gitea/.well-known/openid-configuration"
          iconUrl: "https://auth.test-cluster.agentydragon.com/static/dist/assets/icons/icon.png"
          scopes: "email profile"

      config:
        APP_NAME: "Gitea: Git with a cup of tea"
        RUN_MODE: prod

        server:
          DOMAIN: git.test-cluster.agentydragon.com
          SSH_DOMAIN: git.test-cluster.agentydragon.com
          ROOT_URL: https://git.test-cluster.agentydragon.com
          HTTP_PORT: 3000
          SSH_PORT: 2222
          DISABLE_SSH: false
          START_SSH_SERVER: true

        session:
          PROVIDER: db

        cache:
          ENABLED: true
          ADAPTER: memory

        queue:
          TYPE: level

        security:
          INSTALL_LOCK: true
          SECRET_KEY: "change-this-secret-key-in-production"

        oauth2_client:
          REGISTER_EMAIL_CONFIRM: false
          ENABLE_AUTO_REGISTRATION: true
          USERNAME: nickname
          UPDATE_AVATAR: true
          ACCOUNT_LINKING: login

    # Trust cluster CA bundle (includes Let's Encrypt staging CA)
    deployment:
      env:
        - name: SSL_CERT_FILE
          value: /etc/ssl/certs/cluster-ca/ca-certificates.crt

    # Mount CA bundle to init containers (configure-gitea needs it for OIDC discovery)
    extraVolumes:
      - name: cluster-ca
        configMap:
          name: cluster-internal-ca-bundle

    extraInitVolumeMounts:
      - name: cluster-ca
        mountPath: /etc/ssl/certs/cluster-ca
        readOnly: true

    # Service configuration
    service:
      http:
        type: ClusterIP
        port: 3000
      ssh:
        type: NodePort
        port: 2222
        nodePort: 30501

    # Ingress configuration
    ingress:
      enabled: true
      className: "nginx"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
      hosts:
        - host: git.test-cluster.agentydragon.com
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: gitea-tls
          hosts:
            - git.test-cluster.agentydragon.com

    # Resources
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    # Persistence
    persistence:
      enabled: true
      size: 10Gi

    # PostgreSQL configuration with full chart auto-management
    postgresql:
      enabled: true
      global:
        postgresql:
          auth:
            username: gitea
            database: gitea
            # No password specified - let chart fully auto-generate

    # Disable PostgreSQL HA (using single instance instead)
    postgresql-ha:
      enabled: false

    # Redis (disabled)
    redis-cluster:
      enabled: false

    # Memcached (disabled)
    memcached:
      enabled: false

    # Service account
    serviceAccount:
      create: true
