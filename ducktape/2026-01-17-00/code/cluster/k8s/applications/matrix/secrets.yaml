---
# Synapse signing key using ESO password generator
# Note: Synapse expects format "ed25519 <version> <base64-key>"
apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: synapse-signing-key-generator
  namespace: matrix
spec:
  length: 43 # Base64 encoded 32-byte key
  digits: 10
  symbols: 0
  noUpper: false
  allowRepeat: true
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: synapse-signing-key
  namespace: matrix
spec:
  refreshInterval: 24h
  target:
    name: synapse-signing-key
    creationPolicy: Owner
    template:
      data:
        signing.key: "ed25519 1 {{ .password }}"
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: Password
          name: synapse-signing-key-generator
---
# Registration shared secret using ESO password generator
apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: synapse-registration-secret-generator
  namespace: matrix
spec:
  length: 32
  digits: 10
  symbols: 0
  noUpper: false
  allowRepeat: true
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: synapse-registration-secret
  namespace: matrix
spec:
  refreshInterval: 24h
  target:
    name: synapse-registration-secret
    creationPolicy: Owner
    template:
      data:
        secret: "{{ .password }}"
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: Password
          name: synapse-registration-secret-generator
---
# Macaroon secret key using ESO password generator
apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: synapse-macaroon-secret-generator
  namespace: matrix
spec:
  length: 32
  digits: 10
  symbols: 0
  noUpper: false
  allowRepeat: true
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: synapse-macaroon-secret
  namespace: matrix
spec:
  refreshInterval: 24h
  target:
    name: synapse-macaroon-secret
    creationPolicy: Owner
    template:
      data:
        secret: "{{ .password }}"
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: Password
          name: synapse-macaroon-secret-generator
---
# ExternalSecret for complete Matrix OIDC configuration from Vault
# Terraform stores structured JSON, ESO templates into Helm values format
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: matrix-oidc-secret
  namespace: matrix
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: matrix-oidc-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Template the structured JSON from Vault into YAML for Helm values
        # This will be consumed by HelmRelease valuesFrom
        values.yaml: |
          config:
            extraConfig:
              oidc_providers: {{ .oidc_providers | toJson }}
  dataFrom:
    - extract:
        key: sso/oidc-providers/matrix
---
# PostgreSQL password auto-generated by PostgreSQL chart
