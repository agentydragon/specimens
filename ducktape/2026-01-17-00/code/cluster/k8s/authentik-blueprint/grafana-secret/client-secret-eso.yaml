---
# ExternalSecret for complete Grafana OIDC configuration from Vault
# Terraform writes individual fields to Vault, ESO templates them into YAML
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grafana-oidc-config
  namespace: monitoring
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: grafana-oidc-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Grafana chart requires secrets via env vars + variable expansion
        GF_AUTH_GENERIC_OAUTH_CLIENT_ID: "{{ .client_id }}"
        GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET: "{{ .client_secret }}"
        values.yaml: |
          grafana:
            envFromSecret: grafana-oidc-config
            grafana.ini:
              auth.generic_oauth:
                enabled: {{ .enabled }}
                name: {{ .name | quote }}
                client_id: ${GF_AUTH_GENERIC_OAUTH_CLIENT_ID}
                client_secret: ${GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET}
                scopes: {{ .scopes | quote }}
                auth_url: {{ .auth_url | quote }}
                token_url: {{ .token_url | quote }}
                api_url: {{ .api_url | quote }}
                role_attribute_path: {{ .role_attribute_path | quote }}
                allow_sign_up: {{ .allow_sign_up }}
  dataFrom:
    - extract:
        key: sso/oidc-providers/grafana
