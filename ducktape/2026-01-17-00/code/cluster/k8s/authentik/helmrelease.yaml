---
apiVersion: v1
kind: Namespace
metadata:
  name: authentik
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: authentik
  namespace: authentik
spec:
  interval: 24h
  url: https://charts.goauthentik.io
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: authentik
spec:
  interval: 15m
  timeout: 15m
  chart:
    spec:
      chart: authentik
      version: "2025.10.1"
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: authentik
  values:
    # Global configuration
    global:
      deploymentAnnotations:
        secret.reloader.stakater.com/reload: "authentik-secrets"

    # Authentik server configuration
    authentik:
      # Secret key will be available in the main authentik secret via ESO merge
      secret_key: ""

      # Error reporting
      error_reporting:
        enabled: false

      # PostgreSQL configuration (using built-in PostgreSQL)
      # postgresql config will be auto-generated by chart

      # Redis configuration (optional for better performance)
      redis:
        host: ""

      # Bootstrap configuration (password and token from ESO)
      bootstrap:
        # Password will be injected via extraEnvFrom (ESO-generated)
        password: ""
        # Token will be injected via extraEnvFrom (ESO-generated)
        token: ""

      # Secrets now loaded per-component via server.envFrom and worker.envFrom

    # Server deployment
    server:
      name: server
      replicas: 1

      # Load ESO-generated secret key via envFrom (plus all global secrets)
      envFrom:
        - configMapRef:
            name: authentik-host
        - secretRef:
            name: authentik-bootstrap
        - secretRef:
            name: authentik-admin-password
        - secretRef:
            name: authentik-postgres-env
        - secretRef:
            name: authentik-secret-key

      # Service configuration
      service:
        enabled: true
        type: ClusterIP
        port: 80

      # Ingress configuration
      ingress:
        enabled: true
        ingressClassName: nginx
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-prod"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
        hosts:
          - auth.test-cluster.agentydragon.com
        tls:
          - secretName: authentik-tls
            hosts:
              - auth.test-cluster.agentydragon.com

      # Resources
      resources:
        server:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi

    # Worker deployment
    worker:
      name: worker
      replicas: 1

      # Load ESO-generated secret key via envFrom (plus all global secrets)
      envFrom:
        - configMapRef:
            name: authentik-host
        - secretRef:
            name: authentik-bootstrap
        - secretRef:
            name: authentik-admin-password
        - secretRef:
            name: authentik-postgres-env
        - secretRef:
            name: authentik-secret-key

      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi

    # PostgreSQL with password injected via environment variable
    postgresql:
      enabled: true
      auth:
        existingSecret: "authentik-postgres-env"
        secretKeys:
          adminPasswordKey: "password"
          userPasswordKey: "password"

    # Redis (optional)
    redis:
      enabled: false

    # Service account
    serviceAccount:
      create: true
      name: authentik
