# Create a Kubernetes secret with bootstrap token for Terraform access
# This mirrors what Vault does for its root token
---
apiVersion: v1
kind: Secret
metadata:
  name: authentik-secrets
  namespace: authentik
type: Opaque
stringData:
  # This will be populated by an init container that reads the sealed secret
  bootstrap-token: ""
---
apiVersion: batch/v1
kind: Job
metadata:
  name: copy-authentik-bootstrap-v2
  namespace: authentik
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: copy-token
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              # Wait for bootstrap secret to exist
              while ! kubectl get secret authentik-bootstrap -n authentik; do
                echo "Waiting for authentik-bootstrap secret..."
                sleep 5
              done

              # Copy token to terraform-accessible secret
              TOKEN=$(kubectl get secret authentik-bootstrap -n authentik -o jsonpath='{.data.AUTHENTIK_BOOTSTRAP_TOKEN}' | base64 -d)
              kubectl create secret generic authentik-secrets \
                --from-literal=bootstrap-token="$TOKEN" \
                --namespace=authentik || true

              echo "âœ… Copied Authentik bootstrap token for Terraform access"
      serviceAccountName: authentik-token-copier
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: authentik-token-copier
  namespace: authentik
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: authentik-token-copier
  namespace: authentik
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: authentik-token-copier
  namespace: authentik
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: authentik-token-copier
subjects:
  - kind: ServiceAccount
    name: authentik-token-copier
    namespace: authentik
