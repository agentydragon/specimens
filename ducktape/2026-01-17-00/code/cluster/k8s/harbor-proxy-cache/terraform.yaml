---
apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: harbor-proxy-cache
  namespace: flux-system
spec:
  interval: 15m
  path: ./cluster/terraform/03-configuration/harbor-proxy-cache
  sourceRef:
    kind: GitRepository
    name: flux-system
    namespace: flux-system

  # Use in-cluster service account
  serviceAccountName: tf-runner
  approvePlan: "auto"

  # Store Terraform state in Kubernetes secret
  backendConfig:
    customConfiguration: |
      backend "kubernetes" {
        secret_suffix = "harbor-proxy-cache"
        namespace     = "flux-system"
      }

  # Variables for Terraform
  vars:
    - name: harbor_url
      value: "https://registry.test-cluster.agentydragon.com"

  # No Terraform dependencies - Harbor is deployed via Helm
  # Flux Kustomization dependency ensures Harbor is ready before this runs
