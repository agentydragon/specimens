---
# ExternalSecret to generate Grafana admin password
# Uses Password generator with long refresh to prevent rotation issues
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grafana-admin-password
  namespace: monitoring
spec:
  # Refresh every year to prevent spontaneous auth failures
  # See docs/archive/SECRET_SYNCHRONIZATION_ANALYSIS.md for rotation strategy
  refreshInterval: 8760h
  secretStoreRef:
    name: cluster-secret-store
    kind: ClusterSecretStore
  target:
    name: grafana-admin-password
    template:
      engineVersion: v2
      data:
        admin-user: "admin" # Static username
        admin-password: "{{ .password }}"
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: Password
          name: grafana-admin-password-generator
---
# Password generator for Grafana admin
apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: grafana-admin-password-generator
  namespace: monitoring
spec:
  length: 32
  digits: 5
  symbols: 0 # Avoid special chars that may cause issues
  symbolCharacters: "-_"
  noUpper: false
  allowRepeat: true
