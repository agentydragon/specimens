---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: powerdns
  namespace: dns-system
spec:
  interval: 15m
  timeout: 10m
  chart:
    spec:
      chart: ./charts/powerdns
      sourceRef:
        kind: GitRepository
        name: powerdns-chart
        namespace: dns-system
      interval: 15m
  values:
    # Image configuration - using pschiffe/pdns-mysql with auto-init
    image:
      repository: pschiffe/pdns-mysql
      tag: "4.9"
      pullPolicy: IfNotPresent

    # Service configuration with MetalLB
    service:
      dns:
        type: LoadBalancer
        annotations:
          metallb.universe.tf/address-pool: dns-pool
          metallb.universe.tf/loadBalancerIPs: 10.2.3.3

    # PowerDNS configuration
    powerdns:
      api:
        enabled: true
        secretName: powerdns-api-key
        secretKey: PDNS_API_KEY
      webserver:
        enabled: true
        # Allow all IPs for health probes. Security model:
        # - Webserver (8081) is ClusterIP only, not exposed externally
        # - Zone operations require X-API-Key header (powerdns-api-key secret)
        # - Without API key: only health (/) and metrics (/metrics) accessible
        # - Kubelet probes come from node's INTERNAL-IP; VPS nodes have public IPs,
        #   so RFC1918-only ACL breaks health checks on hybrid VPS+Proxmox cluster
        allowFrom: "0.0.0.0/0"
      backend: "gmysql"

    # External Secret integration - use our chart's built-in ESO support
    externalSecret:
      enabled: true
      secretStore:
        name: vault-backend
        kind: ClusterSecretStore
      secretName: powerdns-api-key

    # MariaDB subchart - database backend with auto-schema-init
    mariadb:
      enabled: true
      auth:
        database: powerdns
        username: powerdns
        # Passwords auto-generated by chart (turnkey, no manual Vault setup)
      primary:
        persistence:
          enabled: true
          storageClass: proxmox-csi-retain
          size: 2Gi
