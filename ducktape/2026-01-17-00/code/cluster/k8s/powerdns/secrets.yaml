# TODO: Migrate PowerDNS API key from terraform-generated Kubernetes secret to Vault secret store
# This terraform resource is a temporary workaround - should use Vault + ExternalSecrets instead
# Generate secure PowerDNS API key
apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: powerdns-secrets
  namespace: flux-system
spec:
  interval: 15m
  path: ./cluster/terraform/dns/secrets
  sourceRef:
    kind: GitRepository
    name: flux-system
    namespace: flux-system

  # Use in-cluster service account
  serviceAccountName: tf-runner

  # Store Terraform state in Kubernetes secret
  backendConfig:
    customConfiguration: |
      backend "kubernetes" {
        secret_suffix    = "powerdns-secrets"
        in_cluster_config = true
        namespace        = "flux-system"
      }

  # Variables for Terraform (uses in-cluster service account auth)

  # Write API key to Kubernetes secret for PowerDNS to use
  writeOutputsToSecret:
    name: powerdns-api-key
    outputs:
      - powerdns_api_key
