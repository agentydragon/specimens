apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: sso-secrets
  namespace: flux-system
spec:
  interval: 15m
  approvePlan: "auto"
  path: ./cluster/terraform/gitops/secrets
  sourceRef:
    kind: GitRepository
    name: flux-system
    namespace: flux-system

  # Use in-cluster service account
  serviceAccountName: tf-runner

  # Configure runner to trust cluster CA
  runnerPodTemplate:
    spec:
      volumes:
        - name: cluster-ca
          configMap:
            name: cluster-internal-ca-bundle
      volumeMounts:
        - name: cluster-ca
          mountPath: /etc/ssl/certs/cluster-ca
          readOnly: true
      env:
        - name: VAULT_CACERT
          value: /etc/ssl/certs/cluster-ca/ca-certificates.crt

  # Store Terraform state in Kubernetes secret
  backendConfig:
    customConfiguration: |
      backend "kubernetes" {
        secret_suffix    = "sso-secrets"
        namespace        = "flux-system"
      }

  # Variables for Terraform
  vars:
    - name: vault_address
      value: "https://instance.vault.svc.cluster.local:8200"
  varsFrom:
    - kind: Secret
      name: vault-token
      varsKeys:
        - vault_token
      optional: false

  # No outputs to write - per-application OIDC secrets are generated by individual blueprints
  # and stored directly in Vault at kv/sso/{app}
