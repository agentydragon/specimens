---
apiVersion: "vault.banzaicloud.com/v1alpha1"
kind: "Vault"
metadata:
  name: "instance"
  namespace: "vault"
spec:
  # HA cluster with 3 replicas for failover
  # Bank-Vaults operator handles Raft cluster formation automatically
  size: 3
  image: "hashicorp/vault:1.17.2"

  # Bank-Vaults automatically handles initialization and unsealing
  # TODO: IPC_LOCK should not require particularly wide privileges - investigate capability restrictions
  bankVaultsImage: "ghcr.io/bank-vaults/bank-vaults:v1.32.0"

  # TLS certificate for internal pod-to-pod communication
  existingTlsSecretName: vault-internal-tls

  # Storage configuration - each replica gets its own PVC
  volumeClaimTemplates:
    - metadata:
        name: vault-raft
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: local-path
        resources:
          requests:
            storage: 10Gi

  volumeMounts:
    - name: vault-raft
      mountPath: /vault/file

  # Raft HA configuration - Bank-Vaults handles cluster formation automatically
  # For fresh bootstrap, Bank-Vaults initializes instance-0 as leader, then joins instance-1 and instance-2
  # retry_join is not needed - Bank-Vaults manages the join process via operator
  # References:
  # - https://github.com/bank-vaults/vault-operator/blob/main/deploy/examples/cr-raft.yaml
  # - https://banzaicloud.com/docs/bank-vaults/operator/
  config:
    storage:
      raft:
        path: "/vault/file"
    listener:
      tcp:
        address: "0.0.0.0:8200"
        cluster_address: "0.0.0.0:8201"
        tls_cert_file: /vault/tls/server.crt
        tls_key_file: /vault/tls/server.key
        tls_client_ca_file: /vault/tls/ca.crt
    # Required addresses for Raft cluster communication
    # References: https://github.com/bank-vaults/vault-operator/blob/main/deploy/examples/
    # api_addr: External address for client requests (load-balanced service)
    # cluster_addr: Pod-specific address for Raft protocol - Bank-Vaults template syntax
    api_addr: "https://instance.vault.svc.cluster.local:8200"
    cluster_addr: "https://${.Env.POD_NAME}.vault.svc.cluster.local:8201"
    ui: true

  # Automatic unsealing using Kubernetes secrets
  unsealConfig:
    options:
      # Store unseal keys and root token in Kubernetes secrets
      preFlightChecks: true
      storeRootToken: true
    kubernetes:
      secretNamespace: "vault"

  # Enable essential auth methods and secrets engines
  externalConfig:
    auth:
      - type: kubernetes
        path: kubernetes

    secrets:
      - path: kv
        type: kv
        description: "General secrets"
        options:
          version: 2

    # Note: PowerDNS API key will be generated by ExternalSecrets Operator
    # using its Password generator and stored in Vault via PushSecret

  # Service configuration
  serviceType: "NodePort"

  # Resource limits (correct Bank-Vaults schema)
  resources:
    vault:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  # Environment variables for templating - Bank-Vaults uses envsConfig (not vaultEnvsConfig)
  # References: https://github.com/bank-vaults/vault-operator/blob/main/deploy/examples/
  envsConfig:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP

  # Service account
  serviceAccount: vault

  # Pod anti-affinity for HA - spread replicas across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: vault
            topologyKey: kubernetes.io/hostname
