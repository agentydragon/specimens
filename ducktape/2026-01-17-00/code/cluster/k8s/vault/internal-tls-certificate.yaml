---
# Internal TLS certificate for Vault pod-to-pod communication
# This certificate includes all pod DNS names and the service name
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vault-internal-tls
  namespace: vault
  annotations:
    # Reflector: automatically copy this secret to other namespaces
    reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
    reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "flux-system"
    reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
    reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "flux-system"
spec:
  secretName: vault-internal-tls
  secretTemplate:
    annotations:
      # Reflector: automatically copy this secret to other namespaces
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "flux-system"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
      reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "flux-system"
  issuerRef:
    name: cluster-internal-ca
    kind: ClusterIssuer
  commonName: instance.vault.svc.cluster.local
  dnsNames:
    # Service name for load-balanced access
    - instance.vault.svc.cluster.local
    - instance.vault.svc
    - instance.vault
    - instance
    # Individual pod names for Raft communication
    - instance-0.vault.svc.cluster.local
    - instance-1.vault.svc.cluster.local
    - instance-2.vault.svc.cluster.local
    - instance-0.vault.svc
    - instance-1.vault.svc
    - instance-2.vault.svc
    # Short names for Raft retry_join (instance.yaml uses these)
    - instance-0.vault
    - instance-1.vault
    - instance-2.vault
    # Localhost for local connections
    - localhost
  ipAddresses:
    - 127.0.0.1
  privateKey:
    algorithm: RSA
    size: 2048
  duration: 8760h # 1 year
  renewBefore: 720h # 30 days
