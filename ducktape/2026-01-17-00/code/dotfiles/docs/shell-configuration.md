# Shell Configuration Guide

This document explains the shell startup file organization for this system.

## Migration Status (2025-10)

**Most shell configuration has been migrated to Nix home-manager** as of October 2025.

- **Shell configurations**: Managed declaratively in `~/code/ducktape/nix/home/home.nix`
  - Programs: `programs.bash`, `programs.zsh`, `programs.atuin`, `programs.direnv`, `programs.zoxide`, `programs.eza`
  - Shell-specific initialization: `~/code/ducktape/nix/home/shell/*.sh` (bash-init.sh, zsh-init.sh, common-init.sh)
  - Aliases: `home.shellAliases`
  - Environment variables: `home.sessionVariables`

- **What remains in dotfiles**:
  - `~/.profile` - Complex conditional PATH management and legacy integrations (CUDA, lesspipe, dotnet, pnpm, machine-specific config)
  - `~/.secret_env` - Secret environment variables (not tracked in git)

- **Nix-managed theme configuration**:
  - `nix/home/p10k.zsh` - Powerlevel10k theme configuration (deployed to ~/.p10k.zsh via home.file)

- **Removed legacy tools** (2025-10):
  - **pyenv** - Not actively used (was set to "system"), Python now managed via Nix
  - **NVM** - Not installed, Node.js now managed via Nix (nodejs_24 package)
  - **Bun** - Now managed via Nix (`bun` package)

- **Deprecated dotfiles** (now managed by Nix):
  - `~/.bashrc` → `programs.bash` in home.nix
  - `~/.zshrc` → `programs.zsh` in home.nix
  - `~/.shellrc` → `home.shellAliases` and shell init scripts
  - `~/.zshenv` → `programs.zsh.envExtra` in home.nix
  - `~/.zprofile` → Not needed (empty)

## Quick Reference (Legacy)

| File            | Purpose                   | Status          | What Goes Here                                                       |
| --------------- | ------------------------- | --------------- | -------------------------------------------------------------------- |
| `~/.profile`    | POSIX environment setup   | **Active**      | PATH, CUDA, lesspipe, machine-specific config, sources ~/.secret_env |
| `~/.bashrc`     | Bash interactive config   | **Nix-managed** | Managed by programs.bash in home.nix                                 |
| `~/.zshenv`     | Zsh environment (minimal) | **Nix-managed** | Managed by programs.zsh.envExtra (skip_global_compinit)              |
| `~/.zprofile`   | Zsh login config          | **Deprecated**  | Empty (not needed)                                                   |
| `~/.zshrc`      | Zsh interactive config    | **Nix-managed** | Managed by programs.zsh in home.nix                                  |
| `~/.shellrc`    | Interactive settings      | **Nix-managed** | Migrated to home.shellAliases and shell init scripts                 |
| `~/.secret_env` | Secret environment vars   | **Active**      | API keys, tokens (not in git)                                        |

## Loading Order (Post-Nix Migration)

**Bold** = files we define | `→` = sourced by shell | `⇒` = sourced by our scripts
Files marked **(Nix)** are generated by home-manager.

### Bash

**Login shell:**

- → `/etc/profile`
- → **`~/.profile`**
  - ⇒ **`~/.secret_env`** (if exists)

**Non-login interactive:**

- → `/etc/bash.bashrc` (Debian/Ubuntu)
- → **`~/.bashrc`** **(Nix)** - generated from `programs.bash` in home.nix
  - Includes `nix/home/shell/bash-init.sh` and `common-init.sh`

### Zsh

- → `/etc/zsh/zshenv`
- → **`~/.zshenv`** **(Nix)** - sets `skip_global_compinit=1`
- **if login:** → `/etc/zsh/zprofile`
- **if interactive:**
  - → `/etc/zsh/zshrc`
  - → **`~/.zshrc`** **(Nix)** - generated from `programs.zsh` in home.nix
    - Loads oh-my-zsh plugins
    - Includes `nix/home/shell/zsh-init.sh` and `common-init.sh`
    - ⇒ **`~/.p10k.zsh`** **(Nix)** - Powerlevel10k config
- **if login:** → `/etc/zsh/zlogin`

### Environment Variables

Session variables from `home.sessionVariables` are set via `~/.nix-profile/etc/profile.d/hm-session-vars.sh`, which is sourced early in shell initialization.

## Key Principles

1. **Nix home-manager is the primary source** for shell configuration, aliases, and most environment variables
2. **`~/.profile` handles PATH and conditionals** - complex PATH logic, CUDA, and machine-specific config that's hard to express in Nix
3. **No duplication** - each setting appears in exactly one place (Nix or profile, not both)
4. **Secrets stay in `~/.secret_env`** - never commit API keys to git

## What Goes Where

### `~/.profile` (Shell-agnostic environment)

- PATH modifications (using `add_path` function) for Rust, Haskell, Go, dotnet, pnpm
- CUDA library path setup
- lesspipe setup
- Secret environment loading (`~/.secret_env`)
- Machine-specific config (`~/.profile.machine`)

Note: Most environment variables (GOPATH, DEFAULT_CHARSET, AIDER_MODEL, etc.) are now in Nix (`home.sessionVariables`).

### `~/.bashrc` / `~/.zshrc` (Nix-managed interactive shell config)

These are now managed by Nix home-manager (`programs.bash`, `programs.zsh` in home.nix).

- Shell options (`shopt`, `setopt`)
- Prompt configuration (Powerlevel10k for zsh)
- Completion setup
- Key bindings
- History settings (atuin)
- oh-my-zsh plugins

### `~/.zshenv` (Zsh-specific environment)

- Minimal - only what MUST run for all zsh (including scripts)
- Currently just `skip_global_compinit=1` (zsh-specific setting)
- Avoid heavy operations here
- Environment variables moved to `~/.profile` for consistency

### `~/.secret_env` (Secret environment variables)

- API keys, tokens, passwords
- Not tracked in git
- Sourced by `~/.profile` if it exists
- Available to all shells through profile

### `~/.shellrc` (Deprecated - migrated to Nix)

This file is no longer used. Its contents have been migrated to:

- `home.shellAliases` in home.nix
- `nix/home/shell/common-init.sh` for interactive functions

## Common Issues

### SSH Sessions

- **Bash**: Automatically sources `~/.bashrc` even for non-login SSH shells (bash detects network connections)
- **Zsh**: SSH creates non-login shells; Nix-generated `~/.zshrc` handles this correctly

### Editing Shell Config

- **Don't edit `~/.bashrc` or `~/.zshrc` directly** - they're generated by Nix and will be overwritten
- **For aliases**: Edit `home.shellAliases` in `nix/home/home.nix`
- **For shell init**: Edit files in `nix/home/shell/` and rebuild
- **Rebuild after changes**: `home-manager switch --flake ~/code/ducktape/nix/home#<hostname>`

### Special Modes & Options

- **Bash as sh**: When invoked as `sh`, bash only reads `/etc/profile` and `~/.profile` for login shells
- **Zsh ZDOTDIR**: Zsh looks for config in `$ZDOTDIR` if set, otherwise `$HOME`
- **Disabling startup files**:
  - Bash: `--noprofile` (skip profile files), `--norc` (skip rc files)
  - Zsh: `unsetopt RCS` (disable user rc files), `unsetopt GLOBAL_RCS` (disable system rc files)

## Remarks

**PATH duplication**: The `add_path()` function in `~/.profile` checks for existing entries before adding.

## Testing Changes

```bash
# After editing Nix config, rebuild:
home-manager switch --flake ~/code/ducktape/nix/home#agentydragon

# Test that aliases work
zsh -i -c 'alias' | grep -E '^(lt|npm)='

# Test environment variables
zsh -c 'echo $EDITOR $GOPATH'

# Test login shell (includes ~/.profile)
bash -l -c 'echo $PATH'
zsh -l -c 'echo $PATH'
```
