"""Database sync module - per-file targets."""

load("@rules_python//python:defs.bzl", "py_library", "py_test")

# =============================================================================
# Library targets
# =============================================================================

py_library(
    name = "_models",
    srcs = ["_models.py"],
    imports = ["../../../.."],
    visibility = ["//props/core/db:__subpackages__"],
    deps = [
        "//props/core:ids",
        "//props/core/models:true_positive",
        "//props/core/models:types",
    ],
)

py_library(
    name = "_yaml_models",
    srcs = ["_yaml_models.py"],
    imports = ["../../../.."],
    visibility = ["//props/core/db:__subpackages__"],
    deps = [
        ":_models",
        "//props/core:ids",
        "//props/core/models:true_positive",
        "//props/core/models:types",
        "@pypi//pydantic",
    ],
)

py_library(
    name = "_yaml",
    srcs = ["_yaml.py"],
    imports = ["../../../.."],
    visibility = ["//props/core/db:__subpackages__"],
    deps = [
        ":_models",
        ":_yaml_models",
        "//props/core:ids",
        "@pypi//pyyaml",
    ],
)

py_library(
    name = "loader",
    srcs = ["loader.py"],
    imports = ["../../../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core/models:snapshot",
        "@pypi//pyyaml",
    ],
)

py_library(
    name = "export",
    srcs = ["export.py"],
    imports = ["../../../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core:ids",
        "//props/core/db:models",
        "@pypi//pyyaml",
        "@pypi//sqlalchemy",
    ],
)

py_library(
    name = "sync",
    srcs = ["sync.py"],
    imports = ["../../../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":_yaml",
        ":loader",
        "//openai_utils",
        "//props/core:ids",
        "//props/core:runs_context",
        "//props/core/db:models",
        "//props/core/db:session",
        "//props/core/models:snapshot",
        "@pypi//pygit2",
        "@pypi//sqlalchemy",
    ],
)

# =============================================================================
# Tests
# =============================================================================

_POSTGRES_TEST_ENV = {
    "PGHOST": "127.0.0.1",
    "PGPORT": "5433",
}

_POSTGRES_TEST_TAGS = [
    "requires_postgres",
]

py_test(
    name = "test_example_generation",
    srcs = ["test_example_generation.py"],
    env = _POSTGRES_TEST_ENV,
    imports = ["../../../.."],
    tags = _POSTGRES_TEST_TAGS,
    deps = [
        ":sync",
        "//props/core/db:examples",
        "//props/core/db:session",
        "//props/testing",
        "@pypi//pytest",
        "@pypi//sqlalchemy",
    ],
)

py_test(
    name = "test_manifest_loading",
    srcs = ["test_manifest_loading.py"],
    env = _POSTGRES_TEST_ENV,
    imports = ["../../../.."],
    tags = _POSTGRES_TEST_TAGS,
    deps = [
        ":loader",
        ":sync",
        "//props/core/db:session",
        "//props/testing",
        "@pypi//pytest",
        "@pypi//sqlalchemy",
    ],
)
