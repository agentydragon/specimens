# Build, test, and release claude_hooks wheel
#
# Runs on:
# - Every push to devel/main (tests always run, release only if changes detected)
# - PRs that touch claude_hooks files (tests only, including wheel mode)
# - Manual workflow_dispatch
#
# Tests: unit + e2e (including podman integration) + wheel mode tests
# On push to devel/main: creates releases if there are target changes since last release
name: Claude Hooks CI

on:
  push:
    branches: [devel, main]
  pull_request:
    paths:
      - "tools/claude_hooks/**"
      - ".github/workflows/claude-hooks-release.yml"
  workflow_dispatch:
    inputs:
      force_release:
        description: "Force release even if no changes detected"
        required: false
        default: false
        type: boolean

# Cancel outdated workflow runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # Check if release is needed (only on push to devel/main)
  check-release:
    name: Check if release needed
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      release_needed: ${{ steps.check.outputs.release_needed }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-bazel
        id: bazel
        with:
          buildbuddy_api_key: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Check if release needed
        id: check
        uses: ./.github/actions/check-release-needed
        with:
          package_prefix: claude-hooks
          bazel_target: //tools/claude_hooks:wheel
          latest_release_tag: claude-hooks-latest

      - uses: ./.github/actions/bazel-cache-save
        if: always()
        with:
          cache-hit: ${{ steps.bazel.outputs.cache-hit }}
          cache-key: ${{ steps.bazel.outputs.cache-key }}
          skip_cache: ${{ steps.bazel.outputs.buildbuddy-enabled }}

  # Unit and E2E tests run on all pushes and PRs
  test:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Java (for keytool)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Verify keytool available
        run: keytool -help >/dev/null

      - uses: ./.github/actions/setup-bazel
        id: bazel
        with:
          buildbuddy_api_key: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Run unit tests (sandboxed)
        run: |
          bazel test --keep_going \
            --test_output=all \
            --nocache_test_results \
            --test_tag_filters=-e2e \
            --test_env=CI=true \
            --test_env=GITHUB_ACTIONS=true \
            --test_env=JAVA_HOME \
            //tools/claude_hooks:all

      - name: Run e2e tests (no sandbox for podman)
        run: |
          # E2E tests need --spawn_strategy=local so podman can create Unix sockets
          bazel test \
            --test_output=all \
            --nocache_test_results \
            --test_tag_filters=e2e \
            --spawn_strategy=local \
            --test_env=CI=true \
            --test_env=GITHUB_ACTIONS=true \
            --test_env=JAVA_HOME \
            --test_env=PATH \
            //tools/claude_hooks:all

      - uses: ./.github/actions/collect-test-logs
        if: always()
        with:
          artifact-name: claude-hooks-test-logs

      # Skip when all tests were remote-cached (no local XML outputs).
      - name: Test Report
        uses: dorny/test-reporter@v2
        if: always() && hashFiles('bazel-testlogs/**/test.xml') != ''
        with:
          name: Claude Hooks Test Results
          path: "bazel-testlogs/**/test.xml"
          reporter: java-junit
          fail-on-error: false

      - uses: ./.github/actions/bazel-cache-save
        if: always()
        with:
          cache-hit: ${{ steps.bazel.outputs.cache-hit }}
          cache-key: ${{ steps.bazel.outputs.cache-key }}
          skip_cache: ${{ steps.bazel.outputs.buildbuddy-enabled }}

  # Wheel mode tests - build wheel, install it, and run tests against installed package
  # Runs on all triggers (PRs and pushes) to catch wheel packaging issues early
  wheel-test:
    name: Wheel Mode Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Java (for keytool)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - uses: ./.github/actions/setup-bazel
        id: bazel
        with:
          buildbuddy_api_key: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Build wheel
        run: bazel build //tools/claude_hooks:wheel

      - name: Install wheel
        run: uv tool install bazel-bin/tools/claude_hooks/claude_hooks-*.whl

      - name: Test installed wheel (including podman integration)
        run: |
          # E2E tests run against the installed wheel (DUCKTAPE_CLAUDE_HOOKS_USE_WHEEL=1).
          # PATH is passed through so podman (pre-installed on GitHub runners) is available.
          # --spawn_strategy=local is required for podman to create Unix sockets.
          bazel test //tools/claude_hooks:test_session_start \
            --test_output=all \
            --nocache_test_results \
            --spawn_strategy=local \
            --test_env=DUCKTAPE_CLAUDE_HOOKS_USE_WHEEL=1 \
            --test_env=CI=true \
            --test_env=JAVA_HOME \
            --test_env=PATH

      - uses: ./.github/actions/collect-test-logs
        if: always()
        with:
          artifact-name: wheel-test-logs

      - uses: ./.github/actions/bazel-cache-save
        if: always()
        with:
          cache-hit: ${{ steps.bazel.outputs.cache-hit }}
          cache-key: ${{ steps.bazel.outputs.cache-key }}
          skip_cache: ${{ steps.bazel.outputs.buildbuddy-enabled }}

  # Release job - only runs on push to devel/main when release is needed
  release:
    name: Release
    needs: [check-release, test, wheel-test]
    if: |
      always() &&
      needs.test.result == 'success' &&
      needs.wheel-test.result == 'success' &&
      (
        (github.event_name == 'push' && needs.check-release.outputs.release_needed == 'true') ||
        (github.event_name == 'workflow_dispatch' && inputs.force_release == true)
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-bazel
        id: bazel
        with:
          buildbuddy_api_key: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Build wheel
        run: bazel build //tools/claude_hooks:wheel

      - name: Set short SHA
        run: echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Prepare wheel for release
        run: |
          mkdir -p dist
          cp bazel-bin/tools/claude_hooks/claude_hooks-*.whl dist/

      - name: Create commit-tagged release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: claude-hooks-${{ env.SHORT_SHA }}
          name: claude-hooks (${{ env.SHORT_SHA }})
          body: |
            claude_hooks wheel for Claude Code web environments.

            Contains:
            - `claude-session-start` - Session start hook for Claude Code web
            - `bazel` / `bazelisk` - Bazel wrapper with proxy support

            Requires Python 3.13+

            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
          files: dist/*.whl

      - name: Cleanup old releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Keep last 10 commit-tagged releases (exclude latest-* tags)
          gh release list --limit 100 \
            | grep "^claude-hooks-" \
            | grep -v "^claude-hooks-latest" \
            | tail -n +11 \
            | cut -f1 \
            | xargs -r -I{} gh release delete {} --yes --cleanup-tag

      - name: Update latest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="claude-hooks-latest"

          # Delete existing release if it exists (we'll recreate it)
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release delete "$TAG" --yes --cleanup-tag
          fi

          # Create the latest release
          gh release create "$TAG" \
            --title "claude-hooks (latest)" \
            --notes "$(cat <<'EOF'
          claude_hooks wheel for Claude Code web environments.

          Contains:
          - \`claude-session-start\` - Session start hook for Claude Code web
          - \`bazel\` / \`bazelisk\` - Bazel wrapper with proxy support

          Requires Python 3.13+

          **This is a rolling release that always points to the latest build.**

          Latest commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          EOF
          )" \
            dist/*.whl

      - uses: ./.github/actions/bazel-cache-save
        if: always()
        with:
          cache-hit: ${{ steps.bazel.outputs.cache-hit }}
          cache-key: ${{ steps.bazel.outputs.cache-key }}
          skip_cache: ${{ steps.bazel.outputs.buildbuddy-enabled }}
