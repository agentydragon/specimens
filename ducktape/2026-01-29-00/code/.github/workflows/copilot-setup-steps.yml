name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      # Clone the repository to set up the environment
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Setup Bazel
        uses: ./.github/actions/setup-bazel
        with:
          buildbuddy_api_key: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Install pre-commit
        run: |
          pip install --user pre-commit==4.0.1
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install pre-commit git hooks
        run: |
          pre-commit install
          pre-commit install --hook-type commit-msg

      - name: Install cluster tools (optional)
        run: |
          # Install opentofu
          TOFU_VERSION="1.9.0"
          curl -fsSL "https://github.com/opentofu/opentofu/releases/download/v${TOFU_VERSION}/tofu_${TOFU_VERSION}_linux_amd64.zip" -o /tmp/tofu.zip
          unzip -q /tmp/tofu.zip -d /tmp
          sudo mv /tmp/tofu /usr/local/bin/tofu
          sudo chmod +x /usr/local/bin/tofu

          # Install tflint
          TFLINT_VERSION="0.53.0"
          curl -fsSL "https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/tflint_linux_amd64.zip" -o /tmp/tflint.zip
          unzip -q /tmp/tflint.zip -d /tmp
          sudo mv /tmp/tflint /usr/local/bin/tflint
          sudo chmod +x /usr/local/bin/tflint
        continue-on-error: true

      - name: Verify environment
        run: |
          echo "=== Environment Setup Complete ==="
          echo "Python version: $(python --version)"
          echo "Bazel version: $(bazel version | head -1)"
          echo "Pre-commit version: $(pre-commit --version)"
          which tofu && echo "OpenTofu version: $(tofu --version | head -1)" || echo "OpenTofu: not installed"
          which tflint && echo "tflint version: $(tflint --version)" || echo "tflint: not installed"

      - name: Set up Props environment variables
        run: |
          # Props E2E test environment variables
          # These mirror the setup used by Claude code hooks (tools/claude_hooks/bazelisk_setup.py)
          # but simplified for GitHub Actions (no HTTP proxy needed, using docker networking)

          echo "ADGN_PROPS_SPECIMENS_ROOT=${{ github.workspace }}/props/testing/fixtures/testdata/specimens" >> $GITHUB_ENV

          # PostgreSQL connection (for props database operations)
          echo "PGHOST=127.0.0.1" >> $GITHUB_ENV
          echo "PGPORT=5433" >> $GITHUB_ENV
          echo "PGUSER=postgres" >> $GITHUB_ENV
          echo "PGDATABASE=eval_results" >> $GITHUB_ENV

          # Agent containers connect to host PostgreSQL
          echo "AGENT_PGHOST=127.0.0.1" >> $GITHUB_ENV

          # Props registry proxy configuration
          echo "PROPS_REGISTRY_PROXY_HOST=127.0.0.1" >> $GITHUB_ENV
          echo "PROPS_REGISTRY_PROXY_PORT=5051" >> $GITHUB_ENV

          # Docker network for agent containers
          # Claude hooks uses "host" network, GitHub Actions uses "props-agents" network
          echo "PROPS_DOCKER_NETWORK=props-agents" >> $GITHUB_ENV

          # Host network address for agent containers to reach host services
          echo "PROPS_E2E_HOST_HOSTNAME=172.17.0.1" >> $GITHUB_ENV

          echo "Props environment variables configured"
