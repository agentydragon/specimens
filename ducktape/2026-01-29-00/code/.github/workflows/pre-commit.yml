# Pre-commit checks reusable workflow
#
# Runs safety checks + Bazel aspects (lint, typecheck, format)
name: Pre-commit checks

on:
  workflow_call:
  workflow_dispatch:

jobs:
  pre-commit:
    name: Pre-commit checks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      # ============================================================================
      # ENVIRONMENT SETUP
      # ============================================================================

      - uses: ./.github/actions/setup-python-env

      # Bazel cache for bazel-operated hooks (buildifier, bazel-format, cluster validations)
      - uses: ./.github/actions/bazel-cache
        id: bazel-cache

      # Cluster validation tools - use official actions where available
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.9.0

      # NOTE: tflint is hermetic via @multitool//tools/tflint in bazel precommit
      # Plugin init is handled by precommit.py (run_tflint runs --init)

      # kubeconform for kubeconform-precommit-hook (not hermetic via Bazel)
      # Other tools (kustomize, flux, helm, kubeseal) are hermetic via @multitool
      - name: Install kubeconform
        run: |
          CHECKSUM="95f14e87aa28c09d5941f11bd024c1d02fdc0303ccaa23f61cef67bc92619d73"
          curl -fsSL -o /tmp/kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz
          echo "$CHECKSUM  /tmp/kubeconform.tar.gz" | sha256sum -c -
          tar xz -C /tmp -f /tmp/kubeconform.tar.gz
          sudo install -m755 /tmp/kubeconform /usr/local/bin/

      # Nix for nixfmt-nix pre-commit hook (runs: nix run nixpkgs#nixfmt)
      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      # Cache Nix store to speed up nixfmt and avoid tarball-cache race conditions
      - name: Restore Nix cache
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-

      # Pre-warm Nix cache to avoid race conditions in pre-commit
      # The nixfmt-nix hook runs `nix run nixpkgs#nixfmt` which can fail if
      # Nix's tarball-cache isn't properly initialized (GitHub Actions issue)
      - name: Pre-warm Nix for nixfmt
        run: nix run nixpkgs#nixfmt -- --version

      - name: Configure OpenTofu for pre-commit
        run: |
          # Set PCT_TFPATH so terraform hooks find opentofu
          echo "PCT_TFPATH=$(which tofu)" >> $GITHUB_ENV

      # Use full 'ansible' package instead of 'ansible-core' to get bundled collections.
      # This avoids Ansible Galaxy API calls entirely - Galaxy has known reliability issues:
      # - Intermittent 500 errors (github.com/ansible/galaxy/issues/2954)
      # - No official status page (github.com/ansible/galaxy/issues/3508)
      # All required collections (community.docker, community.general, community.crypto,
      # ansible.netcommon, ansible.posix) are included in the ansible package.
      - name: Install Ansible
        run: pip install "ansible>=10"

      # Cache Ansible Galaxy roles (required for syntax check - meta/main.yml dependencies)
      - name: Restore Ansible Galaxy roles cache
        id: cache-ansible-roles-restore
        uses: actions/cache/restore@v4
        with:
          path: ~/.ansible/roles
          key: ansible-roles-${{ runner.os }}-${{ hashFiles('ansible/requirements.yaml') }}
          restore-keys: ansible-roles-${{ runner.os }}-

      # Roles ARE needed for syntax checking - ansible-playbook --syntax-check resolves
      # role dependencies from meta/main.yml files (e.g., legacy_gui depends on
      # petermosmans.customize-gnome)
      - name: Install Ansible Galaxy roles
        run: |
          cd ansible
          ansible-galaxy role install -r requirements.yaml

      - name: Restore pre-commit cache
        id: cache-precommit-restore
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      # ============================================================================
      # PRE-COMMIT INSTALLATION
      # ============================================================================

      - name: Install pre-commit
        run: |
          # Version synced with flake.nix (nixpkgs.pre-commit)
          # Update both when bumping pre-commit version
          pip install pre-commit==4.0.1

      # ============================================================================
      # PRE-COMMIT RUN
      # ============================================================================

      - name: Run pre-commit
        run: |
          # Unset NODE_OPTIONS to avoid global-agent requirement in pre-commit's
          # isolated node environments (markdownlint-cli2 hook uses npm)
          unset NODE_OPTIONS
          pre-commit run --all-files --show-diff-on-failure

      # ============================================================================
      # CACHE SAVES
      # ============================================================================

      - uses: ./.github/actions/bazel-cache-save
        if: always()
        with:
          cache-hit: ${{ steps.bazel-cache.outputs.cache-hit }}
          cache-key: ${{ steps.bazel-cache.outputs.cache-key }}

      - name: Save pre-commit cache
        if: always() && steps.cache-precommit-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ steps.cache-precommit-restore.outputs.cache-primary-key }}

      - name: Save Ansible Galaxy roles cache
        if: always() && steps.cache-ansible-roles-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.ansible/roles
          key: ${{ steps.cache-ansible-roles-restore.outputs.cache-primary-key }}
