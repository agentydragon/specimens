# Reusable workflow for building and releasing Python wheels
#
# Creates a GitHub release with commit SHA in tag/filename for content-addressable URLs.
# Automatically cleans up old releases (keeps last 10).
# Optionally creates a stable "latest" release that always points to the most recent build.
name: Python Wheel Release

on:
  workflow_call:
    secrets:
      BUILDBUDDY_API_KEY:
        description: "BuildBuddy API key for remote cache (optional)"
        required: false
    inputs:
      package_name:
        description: "Package name for release tag prefix (e.g., 'ducktape')"
        required: true
        type: string
      wheel_name:
        description: "Wheel filename prefix (e.g., 'ducktape' or 'headscale_cleanup')"
        required: true
        type: string
      bazel_target:
        description: "Bazel target to build (e.g., '//:wheel')"
        required: true
        type: string
      wheel_path:
        description: "Path to wheel in bazel-bin (e.g., 'bazel-bin' or 'bazel-bin/headscale_cleanup')"
        required: true
        type: string
      release_body:
        description: "Release body description (markdown)"
        required: true
        type: string
      apt_packages:
        description: "Space-separated list of apt packages to install (optional)"
        required: false
        type: string
        default: ""
      latest_release_tag:
        description: "Floating tag for the 'latest' release (e.g., 'ducktape-latest'). Creates/updates this release with the same wheel."
        required: true
        type: string

jobs:
  build-and-release:
    name: Build wheel and release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: true

      - name: Set short SHA
        run: echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Install system dependencies
        if: inputs.apt_packages != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ inputs.apt_packages }}

      - uses: ./.github/actions/setup-bazel
        id: bazel
        with:
          buildbuddy_api_key: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Build wheel
        run: bazel build ${{ inputs.bazel_target }}

      - name: Prepare wheel
        run: |
          mkdir -p dist
          # Keep original filename - wheel spec requires proper name format
          cp ${{ inputs.wheel_path }}/${{ inputs.wheel_name }}-*.whl dist/

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.package_name }}-${{ env.SHORT_SHA }}
          name: ${{ inputs.package_name }} (${{ env.SHORT_SHA }})
          body: |
            ${{ inputs.release_body }}

            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
          files: dist/*.whl

      - name: Cleanup old releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Keep last 10 releases with this package prefix (excluding latest tag)
          # TODO: Replace this fragile grep pipeline with a Python script using
          # `gh api` + JSON parsing for more reliable release filtering.
          gh release list --limit 100 \
            | grep "^${{ inputs.package_name }}-" \
            | grep -v "^${{ inputs.latest_release_tag }}" \
            | tail -n +11 \
            | cut -f1 \
            | xargs -r -I{} gh release delete {} --yes --cleanup-tag

      - name: Update latest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.latest_release_tag }}"

          # Delete existing release if it exists (we'll recreate it)
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release delete "$TAG" --yes --cleanup-tag
          fi

          # Create the latest release
          gh release create "$TAG" \
            --title "${{ inputs.package_name }} (latest)" \
            --notes "$(cat <<'EOF'
          ${{ inputs.release_body }}

          **This is a rolling release that always points to the latest build.**

          Latest commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          EOF
          )" \
            dist/*.whl

      - uses: ./.github/actions/bazel-cache-save
        if: always()
        with:
          cache-hit: ${{ steps.bazel.outputs.cache-hit }}
          cache-key: ${{ steps.bazel.outputs.cache-key }}
          skip_cache: ${{ steps.bazel.outputs.buildbuddy-enabled }}
