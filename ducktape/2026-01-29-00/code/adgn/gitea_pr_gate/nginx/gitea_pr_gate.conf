# Nginx allowlist for Gitea basic dev flows, while blocking PR creation.
# - Allows: GET/HEAD/OPTIONS everywhere, Git smart HTTP push/pull, LFS, comments, reviews, merge, close/reopen, update.
# - Blocks: PR creation (web compare POST, API /pulls POST).

upstream gitea_upstream {
    server 127.0.0.1:3000;
}

upstream policy_upstream {
    server 127.0.0.1:9099;
}

server {
    listen 443 ssl;
    server_name _;

    # Default: allow only read methods globally
    location / {
        limit_except GET HEAD OPTIONS { deny all; }
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://gitea_upstream;
    }

    # Git smart HTTP (push/pull) — allow POST to upload/receive-pack
    location ~ ^/[^/]+/[^/]+(?:\.git)?/(git-(?:upload|receive)-pack)$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        proxy_pass http://gitea_upstream;
    }

    # LFS (optional) — batch + object upload/download
    location ~ ^/[^/]+/[^/]+(?:\.git)?/info/lfs/objects/batch$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        proxy_pass http://gitea_upstream;
    }
    location ~ ^/[^/]+/[^/]+(?:\.git)?/info/lfs/objects/[0-9a-f]{64}/.*$ {
        limit_except GET HEAD OPTIONS PUT { deny all; }
        proxy_pass http://gitea_upstream;
    }

    # Web PR close/reopen (guard re-open via policy)
    location ~ ^/[^/]+/[^/]+/pulls/\d+/status$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        auth_request /_policy/pr_quota;  # policy will allow close, gate reopen
        proxy_pass http://gitea_upstream;
    }

    # API PR edit (close/reopen, title/body/target changes) (guard re-open via policy)
    location ~ ^/api/v1/repos/[^/]+/[^/]+/pulls/\d+$ {
        limit_except GET HEAD OPTIONS PATCH { deny all; }
        auth_request /_policy/pr_quota;  # policy will allow edits/close, gate reopen
        proxy_pass http://gitea_upstream;
    }

    # Merge PRs (web + API)
    location ~ ^/[^/]+/[^/]+/pulls/\d+/merge$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        proxy_pass http://gitea_upstream;
    }
    location ~ ^/api/v1/repos/[^/]+/[^/]+/pulls/\d+/merge$ {
        limit_except GET HEAD OPTIONS POST DELETE { deny all; }
        proxy_pass http://gitea_upstream;
    }

    # Update/refresh PR (web + API)
    location ~ ^/[^/]+/[^/]+/pulls/\d+/update$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        proxy_pass http://gitea_upstream;
    }
    location ~ ^/api/v1/repos/[^/]+/[^/]+/pulls/\d+/update$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        proxy_pass http://gitea_upstream;
    }

    # Comments (web + API issue comments work for PRs)
    location ~ ^/[^/]+/[^/]+/pulls/\d+/comments$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        proxy_pass http://gitea_upstream;
    }
    location ~ ^/api/v1/repos/[^/]+/[^/]+/issues/\d+/comments$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        proxy_pass http://gitea_upstream;
    }

    # Reviews (optional; include for formal review/inline code comments)
    location ~ ^/api/v1/repos/[^/]+/[^/]+/pulls/\d+/reviews(?:/.*)?$ {
        limit_except GET HEAD OPTIONS POST DELETE { deny all; }
        proxy_pass http://gitea_upstream;
    }
    location ~ ^/[^/]+/[^/]+/pulls/\d+/files/reviews/(comments|submit)$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        proxy_pass http://gitea_upstream;
    }

    # PR creation (API) — allow only if policy service approves
    location ~ ^/api/v1/repos/[^/]+/[^/]+/pulls$ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        auth_request /_policy/pr_quota;
        proxy_pass http://gitea_upstream;
    }

    # PR creation (Web) — allow only if policy service approves
    location ~ ^/[^/]+/[^/]+/compare/ {
        limit_except GET HEAD OPTIONS POST { deny all; }
        auth_request /_policy/pr_quota;
        proxy_pass http://gitea_upstream;
    }

    # Internal policy endpoint: forwards auth subrequests to quota service
    location = /_policy/pr_quota {
        internal;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;
        # If using Gitea Reverse Proxy Auth (X-Forwarded-User), forward it for policy's optional trust mode
        proxy_set_header X-Original-User $http_x_forwarded_user;
        proxy_pass http://policy_upstream/validate;
    }
}
