"""Git commit AI package."""

# gazelle:python_library_naming_convention $package_name$_lib
load("@rules_python//python:defs.bzl", "py_binary", "py_library", "py_test")
load("@rules_python//python:packaging.bzl", "py_package", "py_wheel")

# Gazelle manages git_ro/ and testing/ subpackages

py_library(
    name = "git_commit_ai_lib",
    data = ["commit_editmsg.mako"],
    visibility = ["//visibility:public"],
    deps = [
        ":agent_backend",
        ":editor",
        "//git_commit_ai/git_ro:formatting",
        "//git_commit_ai/git_ro:server",
    ],
)

py_library(
    name = "config",
    srcs = ["config.py"],
    visibility = ["//:__subpackages__"],
    deps = [
        "@pypi//platformdirs",
        "@pypi//pydantic",
        "@pypi//pydantic_settings",
        "@pypi//pyyaml",
    ],
)

py_binary(
    name = "git_commit_ai",
    srcs = ["cli.py"],
    main = "cli.py",
    visibility = ["//:__subpackages__"],
    deps = [
        ":agent_backend",
        ":config",
        ":editor",
        "//:bazel_util",
        "//cli_util:decorators",
        "@pypi//pygit2",
        "@pypi//typer",
    ],
)

# Package for wheel - bundles git_commit_ai and all local dependencies
py_package(
    name = "git_commit_ai_pkg",
    packages = [
        "agent_core",
        "cli_util",
        "git_commit_ai",
        "mcp_infra",
        "mcp_utils",
        "openai_utils",
    ],
    deps = [":git_commit_ai_lib"],
)

py_wheel(
    name = "git_commit_ai_wheel",
    distribution = "git_commit_ai",
    entry_points = {
        "console_scripts": ["git-commit-ai = git_commit_ai.cli:main"],
    },
    python_requires = ">=3.13",
    requires = [
        "aiodocker",
        "anyio",
        "compact-json",
        "fastmcp>=2.0",
        "httpx",
        "jinja2",
        "mako>=1.3",
        "mcp",
        "openai",
        "pydantic>=2.0",
        "pyhamcrest",
        "pygit2>=1.14",
        "rich",
        "structlog",
        "tenacity",
        "typer",
    ],
    # Strip the src/ prefix from other packages' paths
    strip_path_prefixes = [
        "agent_core/src",
        "cli_util/src",
        "mcp_infra/src",
        "mcp_utils/src",
        "openai_utils/src",
    ],
    version = "0.1.0",
    deps = [":git_commit_ai_pkg"],
)

py_library(
    name = "agent_backend",
    srcs = ["agent_backend.py"],
    data = ["commit_prompt.mako"],
    visibility = ["//:__subpackages__"],
    deps = [
        "//agent_core:agent",
        "//agent_core:handler",
        "//agent_core:loop_control",
        "//agent_core:mcp_provider",
        "//git_commit_ai/git_ro:server",
        "//mcp_infra:mounted",
        "//mcp_infra:prefix",
        "//mcp_infra/bootstrap",
        "//mcp_infra/compositor",
        "//mcp_infra/display:rich_display",
        "//mcp_infra/enhanced:simple",
        "//openai_utils:client_factory",
        "//openai_utils:model",
        "//openai_utils:pydantic_strict_mode",
        "@pypi//fastmcp",
        "@pypi//mako",
        "@pypi//pydantic",
        "@pypi//pygit2",
    ],
)

py_library(
    name = "editor",
    srcs = ["editor.py"],
    data = ["commit_editmsg.mako"],
    visibility = ["//:__subpackages__"],
    deps = [
        "@pypi//mako",
        "@pypi//pygit2",
    ],
)

py_library(
    name = "conftest",
    testonly = True,
    srcs = ["conftest.py"],
    visibility = ["//:__subpackages__"],
    deps = [
        "//git_commit_ai/testing:git_repo_utils",
        "//mcp_infra/testing:fixtures",
        "@pypi//pygit2",
        "@pypi//pytest",
    ],
)

py_test(
    name = "test_amend",
    srcs = ["test_amend.py"],
    deps = [
        ":conftest",
        ":git_commit_ai",
        "@pypi//pygit2",
        "@pypi//pytest",
        "@pypi//pytest_bazel",
    ],
)

py_test(
    name = "test_editor",
    srcs = ["test_editor.py"],
    data = ["__snapshots__/test_editor.ambr"],
    deps = [
        ":conftest",
        ":editor",
        "@pypi//pytest_bazel",
        "@pypi//syrupy",
    ],
)

py_test(
    name = "test_stage_all",
    srcs = ["test_stage_all.py"],
    deps = [
        ":conftest",
        ":git_commit_ai",
        "//git_commit_ai/testing:git_repo_utils",
        "@pypi//pygit2",
        "@pypi//pytest_bazel",
    ],
)
