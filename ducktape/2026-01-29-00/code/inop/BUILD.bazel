"""Instruction optimizer package."""

# gazelle:resolve py inop.engine.optimizer //inop/engine:optimizer
# gazelle:resolve py inop.engine //inop/engine:optimizer

load("@rules_python//python:defs.bzl", "py_library", "py_test")

# no-mypy: statsmodels (transitive dep of plotnine) has broken __init__.py structure
# that causes mypy to error with "Source file found twice under different module names".
# rules_mypy adds all transitive deps to MYPYPATH, and mypy's exclude pattern doesn't
# help because the error occurs during module discovery, not import following.
# See: https://github.com/python/mypy/issues/8944

# Gazelle manages grading/ and runners/ subpackages

# Aggregate target combining all subpackages - for backwards compatibility
py_library(
    name = "inop",
    imports = [".."],
    tags = ["no-mypy"],
    visibility = ["//visibility:public"],
    deps = [
        ":config",
        ":model_factory",
        ":plots",
        "//inop/grading:grader",
        "//inop/grading:strategies",
        "//inop/runners:base",
        "//inop/runners:claude_runner",
        "//inop/runners:containerized_claude",
        "//inop/runners:openai_runner",
    ],
)

py_test(
    name = "test_optimizer_two_iters",
    srcs = ["test_optimizer_two_iters.py"],
    imports = [".."],
    tags = ["no-mypy"],  # see comment on inop library
    deps = [
        ":config",
        ":conftest",
        "//inop/engine:models",
        "//inop/engine:optimizer",
        "//inop/engine:runner_factory",
        "//inop/io:jsonl_logger",
        "//inop/runners:base",
        "//mcp_infra:naming",
        "//mcp_infra:prefix",
        "//openai_utils:model",
        "//openai_utils:types",
        "@pypi//aiodocker",
        "@pypi//pytest",
        "@pypi//pytest_asyncio",  # keep
        "@pypi//pytest_bazel",
    ],
)

py_library(
    name = "config",
    srcs = ["config.py"],
    visibility = ["//:__subpackages__"],
    deps = [
        "//openai_utils:types",
        "@pypi//pydantic",
        "@pypi//pyyaml",
    ],
)

py_library(
    name = "model_factory",
    srcs = ["model_factory.py"],
    visibility = ["//:__subpackages__"],
    deps = [
        ":config",
        "//openai_utils:client_factory",
        "//openai_utils:model",
        "//openai_utils:types",
    ],
)

py_library(
    name = "plots",
    srcs = ["plots.py"],
    visibility = ["//:__subpackages__"],
    deps = [
        "//inop/io:logging_utils",
        "@pypi//matplotlib",
        "@pypi//pandas",
        "@pypi//plotnine",
        "@pypi//pydantic",
        "@pypi//tiktoken",
    ],
)

py_library(
    name = "conftest",
    testonly = True,
    srcs = ["conftest.py"],
    visibility = ["//:__subpackages__"],
    deps = [
        "//agent_core_testing:responses",
        "@pypi//pytest",
    ],
)

py_test(
    name = "test_config",
    srcs = ["test_config.py"],
    deps = [
        ":config",
        ":conftest",
        "@pypi//pytest_bazel",
        "@pypi//pyyaml",
    ],
)

py_test(
    name = "test_exclusion_patterns",
    srcs = ["test_exclusion_patterns.py"],
    deps = [
        ":conftest",
        "@pypi//pathspec",
        "@pypi//pytest_bazel",
    ],
)

py_test(
    name = "test_file_truncation",
    srcs = ["test_file_truncation.py"],
    deps = [
        ":conftest",
        "//inop/engine:models",
        "//inop/prompting:truncation_utils",
        "@pypi//pytest_bazel",
        "@pypi//tiktoken",
    ],
)

py_test(
    name = "test_types",
    srcs = ["test_types.py"],
    deps = [
        ":conftest",
    ],
)
