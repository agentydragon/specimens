load("@rules_python//python:defs.bzl", "py_library", "py_test")
load("//tools/deps:check.bzl", "assert_no_deps")

# Core models - no MCP dependencies, usable outside fastmcp
py_library(
    name = "models",
    srcs = ["models.py"],
    imports = ["../.."],
    visibility = ["//visibility:public"],
    deps = [
        "//openai_utils:pydantic_strict_mode",
        "@pypi//pydantic",
    ],
)

# Subprocess execution utility - no MCP dependencies
# Includes DirectExecArgs and run_direct_exec for in-container agent loops
py_library(
    name = "subprocess",
    srcs = ["subprocess.py"],
    imports = ["../.."],
    visibility = ["//visibility:public"],
    deps = [
        ":models",
        "@pypi//pydantic",
    ],
)

# Image reading utility (shared by direct, seatbelt, bwrap, docker)
py_library(
    name = "read_image",
    srcs = ["read_image.py"],
    imports = ["../.."],
    visibility = ["//visibility:public"],
    deps = [
        "//openai_utils:pydantic_strict_mode",
        "@pypi//mcp",
    ],
)

# Direct (unsandboxed) exec MCP server
py_library(
    name = "direct",
    srcs = ["direct.py"],
    imports = ["../.."],
    visibility = ["//visibility:public"],
    deps = [
        ":models",
        ":read_image",
        ":subprocess",
        "//mcp_infra/enhanced:flat_mixin",
        "//mcp_infra/enhanced:server",
        "@pypi//mcp",
    ],
)

# macOS seatbelt sandbox exec MCP server
py_library(
    name = "seatbelt",
    srcs = ["seatbelt.py"],
    imports = ["../.."],
    visibility = ["//visibility:public"],
    deps = [
        ":models",
        ":read_image",
        "//mcp_infra/enhanced:flat_mixin",
        "//mcp_infra/enhanced:server",
        "//mcp_infra/seatbelt:model",
        "//mcp_infra/seatbelt:runner",
        "@pypi//anyio",
        "@pypi//fastmcp",
        "@pypi//mcp",
        "@pypi//pydantic",
    ],
)

# Linux bubblewrap sandbox exec MCP server
py_library(
    name = "bwrap",
    srcs = ["bwrap.py"],
    imports = ["../.."],
    visibility = ["//visibility:public"],
    deps = [
        ":models",
        ":read_image",
        ":subprocess",
        "//mcp_infra/enhanced:flat_mixin",
        "//mcp_infra/enhanced:server",
        "@pypi//fastmcp",
        "@pypi//mcp",
        "@pypi//pydantic",
    ],
)

# Docker container exec MCP server
py_library(
    name = "docker",
    srcs = [
        "docker/container_session.py",
        "docker/launcher.py",
        "docker/server.py",
    ],
    imports = ["../.."],
    visibility = ["//visibility:public"],
    deps = [
        ":models",
        ":read_image",
        "//cli_util:decorators",
        "//cli_util:logging",
        "//mcp_infra:constants",
        "//mcp_infra:mcp_types",
        "//mcp_infra:prefix",
        "//mcp_infra/enhanced:flat_mixin",
        "//mcp_infra/enhanced:server",
        "//mcp_infra/enhanced:simple",
        "@pypi//aiodocker",
        "@pypi//anyio",
        "@pypi//fastmcp",
        "@pypi//mcp",
        "@pypi//typer_di",
    ],
)

py_library(
    name = "matchers",
    srcs = ["matchers.py"],
    imports = ["../.."],
    visibility = ["//:__subpackages__"],
    deps = [
        ":models",
        "@pypi//pyhamcrest",
    ],
)

py_test(
    name = "test_direct",
    srcs = ["test_direct.py"],
    deps = [
        ":conftest",
        ":direct",
        ":models",
        ":subprocess",
        "//mcp_infra/testing:exec_stubs",
        "@pypi//fastmcp",
        "@pypi//pytest_bazel",
    ],
)

py_test(
    name = "test_seatbelt",
    srcs = ["test_seatbelt.py"],
    deps = [
        ":conftest",
        ":models",
        ":seatbelt",
        "//mcp_infra:_markers",
        "//mcp_infra/seatbelt:model",
        "//mcp_infra/testing:exec_stubs",
        "@pypi//fastmcp",
        "@pypi//pytest",
        "@pypi//pytest_bazel",
    ],
)

py_test(
    name = "test_bwrap",
    srcs = ["test_bwrap.py"],
    deps = [
        ":bwrap",
        ":conftest",
        ":models",
        "//mcp_infra/testing:exec_stubs",
        "@pypi//fastmcp",
        "@pypi//pytest",
        "@pypi//pytest_bazel",
    ],
)

py_test(
    name = "test_docker",
    srcs = ["test_docker.py"],
    data = ["//mcp_infra/testing:python_slim_load"],
    main = "test_docker.py",
    tags = ["requires_docker"],
    deps = [
        ":conftest",
        ":models",
        "@pypi//pytest",
        "@pypi//pytest_bazel",
    ],
)

# Verify models and subprocess have no MCP/fastmcp dependencies
assert_no_deps(
    name = "test_models_no_mcp_deps",
    forbidden = [
        "@pypi//fastmcp",
        "@pypi//mcp",
    ],
    target = "//mcp_infra/exec:models",
)

assert_no_deps(
    name = "test_subprocess_no_mcp_deps",
    forbidden = [
        "@pypi//fastmcp",
        "@pypi//mcp",
    ],
    target = "//mcp_infra/exec:subprocess",
)

py_library(
    name = "conftest",
    testonly = True,
    srcs = ["conftest.py"],
    visibility = ["//:__subpackages__"],
    deps = [
        "//mcp_infra/testing:docker_fixtures",
        "//test_util",
        "@pypi//pytest",
    ],
)

py_test(
    name = "test_docker_unit",
    srcs = ["test_docker_unit.py"],
    deps = [
        ":conftest",
        ":docker",
        ":models",
        "//mcp_infra/testing:fixtures",
        "@pypi//fastmcp",
        "@pypi//pytest",
        "@pypi//pytest_bazel",
    ],
)
