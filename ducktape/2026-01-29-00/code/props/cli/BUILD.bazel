# Props has complex inter-package dependencies that are manually configured

"""CLI module - per-file targets."""

# gazelle:python_library_naming_convention $package_name$_lib
load("@rules_oci//oci:defs.bzl", "oci_image", "oci_load", "oci_push")
load("@rules_pkg//pkg:tar.bzl", "pkg_tar")
load("@rules_python//python:defs.bzl", "py_binary", "py_library", "py_test")

# =============================================================================
# Leaf modules (minimal deps)
# =============================================================================

py_library(
    name = "types",
    srcs = ["types.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core:ids",
        "@pypi//click",
        "@pypi//pydantic",
    ],
)

py_library(
    name = "common_options",
    srcs = ["common_options.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":types",
        "@pypi//typer_slim",
    ],
)

py_library(
    name = "resources",
    srcs = ["resources.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = ["//props/db:config"],
)

py_library(
    name = "shared",
    srcs = ["shared.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core:ids",
        "//props/core:runs_context",
        "//props/core/models:examples",
        "@pypi//tiktoken",
        "@pypi//typer_slim",
    ],
)

# =============================================================================
# Subcommand modules
# =============================================================================

py_library(
    name = "cmd_agent_pkg",
    srcs = ["cmd_agent_pkg.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core:agent_types",
        "//props/db:models",
        "//props/db:session",
        "@pypi//typer_slim",
    ],
)

py_library(
    name = "cmd_classify_noops",
    srcs = ["cmd_classify_noops.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":common_options",
        "//openai_utils:client_factory",
        "//props/core/noop_classifier:classifier",
        "@pypi//rich",
        "@pypi//typer_slim",
    ],
)

# Note: cmd_critic_dev and cmd_critic_dev_helpers moved to //props/critic_dev

py_library(
    name = "cmd_db",
    srcs = ["cmd_db.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/db:config",
        "//props/db:session",
        "//props/db:setup",
        "//props/db/sync",
        "@pypi//rich",
        "@pypi//typer_slim",
    ],
)

py_library(
    name = "cmd_gepa",
    srcs = ["cmd_gepa.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":common_options",
        "//cli_util:decorators",
        "//openai_utils:client_factory",
        "//props/core:agent_workspace",
        "//props/core/gepa:gepa_adapter",
        "//props/db:config",
        "@pypi//rich",
        "@pypi//typer_slim",
    ],
)

py_library(
    name = "cmd_grade_validation",
    srcs = ["cmd_grade_validation.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":common_options",
        ":resources",
        "//cli_util:decorators",
        "//props/core:agent_types",
        "//props/core:display",
        "//props/core:splits",
        "//props/core/models:examples",
        "//props/db:examples",
        "//props/db:models",
        "//props/db:session",
        "//props/orchestration:agent_registry",
        "@pypi//aiodocker",
        "@pypi//typer_slim",
    ],
)

py_library(
    name = "cmd_grader_agent",
    srcs = ["cmd_grader_agent.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core:display",
        "//props/db:models",
        "//props/db:session",
        "//props/grader:edge_helpers",
        "@pypi//rich",
        "@pypi//typer_slim",
    ],
)

py_library(
    name = "cmd_gt",
    srcs = ["cmd_gt.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core:ids",
        "//props/db:session",
        "//props/db/sync:export",
        "@pypi//rich",
        "@pypi//typer_slim",
    ],
)

py_library(
    name = "cmd_snapshot",
    srcs = ["cmd_snapshot.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":common_options",
        "//cli_util:decorators",
        "//props/core:ids",
        "//props/db:models",
        "//props/db:session",
        "//props/db:snapshot_io",
        "//props/db/sync:export",
        "@pypi//typer_di",
        "@pypi//typer_slim",
    ],
)

py_library(
    name = "cmd_stats",
    srcs = ["cmd_stats.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core:agent_types",
        "//props/core:display",
        "//props/core:splits",
        "//props/core/models:examples",
        "//props/db:examples",
        "//props/db:models",
        "//props/db:query_builders",
        "//props/db:session",
        "@pypi//plotext",
        "@pypi//rich",
        "@pypi//sqlalchemy",
        "@pypi//typer_slim",
    ],
)

# =============================================================================
# Main entry point
# =============================================================================

py_library(
    name = "main",
    srcs = ["__main__.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":cmd_agent_pkg",
        ":cmd_classify_noops",
        ":cmd_db",
        ":cmd_gepa",
        ":cmd_grade_validation",
        ":cmd_grader_agent",
        ":cmd_gt",
        ":cmd_snapshot",
        ":cmd_stats",
        ":common_options",
        ":shared",
        "//cli_util:decorators",
        "//cli_util:logging",
        "//openai_utils:model",
        "//props/core:agent_helpers",
        "//props/core:agent_types",
        "//props/core:agent_workspace",
        "//props/core:display",
        "//props/core:ids",
        "//props/core:runs_context",
        "//props/core:splits",
        "//props/core/models:examples",
        "//props/critic_dev:shared",
        "//props/critic_dev/improve:main",
        "//props/db:config",
        "//props/db:models",
        "//props/db:query_builders",
        "//props/db:session",
        "//props/orchestration:agent_registry",
        "@pypi//aiodocker",
        "@pypi//rich",
        "@pypi//sqlalchemy",
        "@pypi//typer",
        "@pypi//typer_di",
    ],
)

py_binary(
    name = "cli",
    srcs = ["__main__.py"],
    main = "__main__.py",
    visibility = ["//visibility:public"],
    deps = [
        ":cmd_agent_pkg",
        ":cmd_classify_noops",
        ":cmd_db",
        ":cmd_gepa",
        ":cmd_grade_validation",
        ":cmd_grader_agent",
        ":cmd_gt",
        ":cmd_snapshot",
        ":cmd_stats",
        ":common_options",
        ":shared",
        "//cli_util:decorators",
        "//cli_util:logging",
        "//props/core:agent_helpers",
        "//props/core:agent_types",
        "//props/core:display",
        "//props/core:ids",
        "//props/core:splits",
        "//props/core/models:examples",
        "//props/critic_dev:shared",
        "//props/critic_dev/improve:main",
        "//props/db:config",
        "//props/db:models",
        "//props/db:query_builders",
        "//props/db:session",
        "//props/orchestration:agent_registry",
        "@pypi//aiodocker",
        "@pypi//rich",
        "@pypi//typer_di",
        "@pypi//typer_slim",
    ],
)

# =============================================================================
# Tests
# =============================================================================

py_test(
    name = "test_agent_pkg",
    srcs = ["test_agent_pkg.py"],
    imports = ["../.."],
    deps = [
        ":cmd_agent_pkg",
        "//props/core:agent_pkg_utils",
        "@pypi//pytest",
        "@pypi//pytest_bazel",
        "@pypi//typer_slim",
    ],
)

# =============================================================================
# Shared CLI packaging (used by all agent images)
# =============================================================================

pkg_tar(
    name = "app_tar",
    srcs = [":cli"],
    include_runfiles = True,
    package_dir = "/app",
    strip_prefix = ".",
    visibility = ["//props:__subpackages__"],
)

# =============================================================================
# OCI Image for GHCR (specimens validation)
# =============================================================================

oci_image(
    name = "image",
    base = "@python_slim_linux_amd64",
    entrypoint = ["/app/cli"],
    env = {
        "PYTHONDONTWRITEBYTECODE": "1",
        "PYTHONUNBUFFERED": "1",
    },
    tars = [":app_tar"],
    workdir = "/specimens",
)

oci_load(
    name = "load",
    image = ":image",
    repo_tags = ["props-cli:latest"],
)

oci_push(
    name = "push_ghcr",
    image = ":image",
    remote_tags = ["latest"],
    repository = "ghcr.io/agentydragon/props-cli",
)
