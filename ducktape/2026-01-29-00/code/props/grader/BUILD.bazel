"""Grader agent - implementation and container images.

Two images for different grader modes:
- grader: One-off grader that grades a single critic run
- grader_daemon: Persistent daemon that grades all critiques for a snapshot

Build targets:
    bazel run //props/grader:load         -- Load one-off grader
    bazel run //props/grader:push         -- Push one-off grader
    bazel run //props/grader:daemon_load  -- Load daemon grader
    bazel run //props/grader:daemon_push  -- Push daemon grader

The containers run an agent loop that:
1. Fetches snapshot to /workspace
2. Renders system prompt from template
3. Queries LLM via proxy (OPENAI_BASE_URL)
4. Executes grader tools (list_pending, insert_edges, submit, etc.)
5. One-off: exits 0 on successful submit
6. Daemon: sleeps on pg_notify, wakes to grade new critiques
"""

load("@rules_oci//oci:defs.bzl", "oci_image", "oci_load", "oci_push")
load("@rules_pkg//pkg:tar.bzl", "pkg_tar")
load("@rules_python//python:defs.bzl", "py_binary", "py_library", "py_test")

# =============================================================================
# In-container agent loop
# =============================================================================

py_library(
    name = "tools",
    srcs = ["tools.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "@pypi//pydantic",
    ],
)

py_library(
    name = "loop",
    srcs = ["loop.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":tools",
        "//agent_core:agent",
        "//agent_core:direct_provider",
        "//agent_core:handler",
        "//agent_core:loop_control",
        "//mcp_infra/exec:models",
        "//mcp_infra/exec:subprocess",
        "//openai_utils:model",
        "//props/core:agent_helpers",
        "//props/core:ids",
        "//props/db:models",
        "//props/db:session",
        "@pypi//openai",
        "@pypi//sqlalchemy",
    ],
)

# =============================================================================
# In-container agent main entry point (daemon grader)
# =============================================================================

py_library(
    name = "main",
    srcs = ["main.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":drift_handler",
        ":loop",
        ":notifications",
        "//props/core:agent_helpers",
        "//props/core:ids",
        "//props/core:loop_utils",
        "//props/db:config",
        "//props/db:session",
        "@pypi//asyncpg",
        "@pypi//jinja2",
    ],
)

py_binary(
    name = "grader",
    srcs = ["main.py"],
    main = "main.py",
    visibility = ["//visibility:public"],
    deps = [
        ":main",
    ],
)

pkg_tar(
    name = "main_tar",
    srcs = [":grader"],
    include_runfiles = True,
    package_dir = "/app",
    strip_prefix = ".",
    visibility = ["//props:__subpackages__"],
)

# =============================================================================
# Library targets
# =============================================================================

py_library(
    name = "persistence",
    srcs = ["persistence.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/db:models",
        "//props/db:snapshots",
    ],
)

py_library(
    name = "drift_handler",
    srcs = ["drift_handler.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":notifications",
        "//agent_core:handler",
        "//agent_core:loop_control",
        "//openai_utils:model",
        "//props/db:session",
        "@pypi//sqlalchemy",
    ],
)

py_library(
    name = "daemon",
    srcs = ["daemon.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        ":drift_handler",
        ":notifications",
        "//props/core:ids",
        "//props/db:config",
        "@pypi//asyncpg",
    ],
)

py_library(
    name = "notifications",
    srcs = ["notifications.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core:ids",
        "@pypi//pydantic",
    ],
)

py_library(
    name = "edge_helpers",
    srcs = ["edge_helpers.py"],
    imports = ["../.."],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/db:models",
        "//props/db:session",
        "@pypi//sqlalchemy",
    ],
)

# =============================================================================
# Tests
# =============================================================================

py_test(
    name = "test_grading_edges_constraints",
    srcs = ["test_grading_edges_constraints.py"],
    imports = ["../.."],
    tags = ["requires_docker"],
    deps = [
        ":conftest",
        "//props/db:models",
        "//props/db:session",
        "//props/testing/fixtures:runs",
        "@pypi//pytest",
        "@pypi//pytest_asyncio",  # keep
        "@pypi//pytest_bazel",
        "@pypi//sqlalchemy",
    ],
)

py_test(
    name = "test_matchable_occurrences",
    srcs = ["test_matchable_occurrences.py"],
    imports = ["../.."],
    tags = ["requires_docker"],
    deps = [
        ":conftest",
        "//props/db:session",
        "@pypi//pytest",
        "@pypi//pytest_asyncio",  # keep
        "@pypi//pytest_bazel",
        "@pypi//sqlalchemy",
    ],
)

py_test(
    name = "test_e2e",
    srcs = ["test_e2e.py"],
    data = [
        ":load",  # Grader daemon image
    ],
    imports = ["../.."],
    tags = [
        "e2e",
        "requires_docker",
    ],
    deps = [
        ":conftest",
        "//agent_core_testing:responses",
        "//props/db:models",
        "//props/db:session",
        "//props/db:snapshots",
        "//props/testing",
        "//props/testing/fixtures:runs",
        "@pypi//pytest",
        "@pypi//pytest_asyncio",  # keep
        "@pypi//pytest_bazel",
    ],
)

# =============================================================================
# Container image (daemon grader)
# =============================================================================

oci_image(
    name = "image",
    base = "@python_slim_linux_amd64",
    cmd = ["/app/grader"],
    env = {
        "PYTHONDONTWRITEBYTECODE": "1",
        "PYTHONUNBUFFERED": "1",
    },
    tars = [":main_tar"],
    workdir = "/workspace",
)

oci_load(
    name = "load",
    image = ":image",
    repo_tags = ["grader-agent:latest"],
    visibility = ["//visibility:public"],
)

oci_push(
    name = "push",
    image = ":image",
    remote_tags = ["latest"],
    repository = "localhost:8000/grader",
)

py_library(
    name = "conftest",
    testonly = True,
    srcs = ["conftest.py"],
    visibility = ["//props:__subpackages__"],
    deps = [
        "//props/core/models:examples",
        "//props/db:examples",
        "//props/db:models",
        "//props/db:session",
        "//props/testing/fixtures:runs",
        "@pypi//pytest",
    ],
)
