# Formatters for bazel run //tools/format
#
# Usage:
#   bazel run //tools/format -- file1.py file2.js  # Format specific files
#   bazel run //tools/format                        # Format all tracked files

load("@aspect_rules_lint//format:defs.bzl", "format_multirun")
load("@rules_python//python:defs.bzl", "py_binary")

package(default_visibility = ["//visibility:public"])

# Custom formatter that handles filenames with special characters correctly.
# Unlike rules_lint's format.sh, this doesn't use `find` which breaks on filenames
# containing dashes that look like predicates (e.g., "-recipe-").
py_binary(
    name = "format",
    srcs = ["__main__.py"],
    data = [
        "//tools/lint:prettier",
        "@aspect_rules_lint//format:ruff",
        "@aspect_rules_lint//format:shfmt",
        "@buildifier_prebuilt//buildifier",
    ],
    env = {
        "BUILDIFIER_BIN": "$(rlocationpath @buildifier_prebuilt//buildifier:buildifier)",
        "PRETTIER_BIN": "$(rlocationpath //tools/lint:prettier)",
        "RUFF_BIN": "$(rlocationpath @aspect_rules_lint//format:ruff)",
        "SHFMT_BIN": "$(rlocationpath @aspect_rules_lint//format:shfmt)",
    },
    main = "__main__.py",
    deps = [
        "//tools:env_utils",
        "@pypi//pygit2",
        "@rules_python//python/runfiles",
    ],
)

# Check-only mode - same script with FMT_CHECK=1
py_binary(
    name = "format.check",
    srcs = ["__main__.py"],
    data = [
        "//tools/lint:prettier",
        "@aspect_rules_lint//format:ruff",
        "@aspect_rules_lint//format:shfmt",
        "@buildifier_prebuilt//buildifier",
    ],
    env = {
        "BUILDIFIER_BIN": "$(rlocationpath @buildifier_prebuilt//buildifier:buildifier)",
        "PRETTIER_BIN": "$(rlocationpath //tools/lint:prettier)",
        "RUFF_BIN": "$(rlocationpath @aspect_rules_lint//format:ruff)",
        "SHFMT_BIN": "$(rlocationpath @aspect_rules_lint//format:shfmt)",
        "FMT_CHECK": "1",
    },
    main = "__main__.py",
    deps = [
        "//tools:env_utils",
        "@pypi//pygit2",
        "@rules_python//python/runfiles",
    ],
)

# Keep the old format_multirun as format_old for comparison/fallback
format_multirun(
    name = "format_old",
    css = "//tools/lint:prettier",
    html = "//tools/lint:prettier",
    javascript = "//tools/lint:prettier",
    markdown = "//tools/lint:prettier",
    python = "@aspect_rules_lint//format:ruff",
    rust = "@rules_rust//:rustfmt",
    shell = "@aspect_rules_lint//format:shfmt",
    starlark = "//tools/lint:buildifier",
)
